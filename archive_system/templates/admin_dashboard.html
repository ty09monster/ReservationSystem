<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå°</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
        .reason-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 100px;
            overflow-y: auto;
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: bold;
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .detail-value {
            margin-bottom: 12px;
            font-size: 1rem;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark px-4">
        <a class="navbar-brand" href="#">æ¡£æ¡ˆé¦†é¢„çº¦ç®¡ç†ç³»ç»Ÿ</a>
        <span class="navbar-text text-white">
            {% if session['is_super'] %}
            ğŸš€ è¶…çº§ç®¡ç†å‘˜
            {% else %}
            ğŸ‘¤ æ™®é€šç®¡ç†å‘˜
            {% endif %}
        </span>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-2">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-audit">
                        ğŸ“… é¢„çº¦å®¡æ ¸
                    </button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-notice">
                        ğŸ“¢ å…¬å‘Šç®¡ç†
                    </button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-config">
                        âš™ï¸ ç³»ç»Ÿé…ç½®
                    </button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-account">
                        ğŸ‘® è´¦å·ç®¡ç†
                    </button>

                    <a href="{{ url_for('admin_logout') }}" class="nav-link text-danger mt-4">
                        ğŸšª é€€å‡ºç™»å½•
                    </a>
                </div>
            </div>

            <div class="col-md-10">
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ messages[0] }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                    </button>
                </div>
                {% endif %}
                {% endwith %}

                <div class="tab-content">

                    <div class="tab-pane fade show active" id="tab-audit">
                        <h4>é¢„çº¦ç”³è¯·åˆ—è¡¨</h4>

                        <div class="card bg-light mb-3 mt-3">
                            <div class="card-body py-3">
                                <form method="GET" action="{{ url_for('admin_dashboard') }}"
                                    class="row g-2 align-items-center">
                                    <div class="col-auto">
                                        <select name="status" class="form-select">
                                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                            <option value="å¾…å®¡æ ¸" {% if curr_status=='å¾…å®¡æ ¸' %}selected{% endif %}>
                                                å¾…å®¡æ ¸
                                            </option>
                                            <option value="å·²åŒæ„" {% if curr_status=='å·²åŒæ„' %}selected{% endif %}>
                                                å·²åŒæ„
                                            </option>
                                            <option value="å·²æ‹’ç»" {% if curr_status=='å·²æ‹’ç»' %}selected{% endif %}>
                                                å·²æ‹’ç»
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" name="keyword" class="form-control" placeholder="æœç´¢å§“åæˆ–æ‰‹æœºå·"
                                            value="{{ curr_keyword }}">
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary">
                                            ğŸ” æŸ¥è¯¢
                                        </button>
                                        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                                            é‡ç½®
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <table class="table table-hover mt-3 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>æäº¤æ—¶é—´</th>
                                    <th>å§“å</th>
                                    <th>èº«ä»½</th>
                                    <th>å‚è§‚æ—¥æœŸ/æ—¶é—´</th>
                                    <th>æ ¡åŒº</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if reservations|length == 0 %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•
                                    </td>
                                </tr>
                                {% else %}
                                {% for res in reservations %}
                                <tr>
                                    <td>{{ res.created_at.strftime('%m-%d %H:%M') }}</td>
                                    <td>{{ res.user.name }}</td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ res.identity }}
                                        </span>
                                    </td>
                                    <td>
                                        {{ res.visit_date }}<br>
                                        <small class="text-muted">
                                            {{ res.visit_time }}
                                        </small>
                                    </td>
                                    <td>{{ res.area }}</td>
                                    <td>
                                        {% if res.status == 'å¾…å®¡æ ¸' %}
                                        <span class="badge bg-warning text-dark">
                                            å¾…å®¡æ ¸
                                        </span>
                                        {% elif res.status == 'å·²åŒæ„' %}
                                        <span class="badge bg-success">
                                            å·²åŒæ„
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            å·²æ‹’ç»
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="openAuditModal(this)"
                                            data-id="{{ res.id }}"
                                            data-time="{{ res.created_at.strftime('%Y-%m-%d %H:%M') }}"
                                            data-name="{{ res.user.name }}" data-phone="{{ res.user.phone }}"
                                            data-idtype="{{ res.user.id_type }}" data-idcard="{{ res.user.id_card }}"
                                            data-identity="{{ res.identity }}"
                                            data-visitdate="{{ res.visit_date }} {{ res.visit_time }}"
                                            data-area="{{ res.area }}" data-reason="{{ res.reason }}"
                                            data-status="{{ res.status }}"
                                            data-rejectreason="{{ res.reject_reason or '' }}">
                                            æŸ¥çœ‹è¯¦æƒ…
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>

                        {% if pagination.pages > 1 %}
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link"
                                        href="{{ url_for('admin_dashboard', page=pagination.prev_num, keyword=curr_keyword, status=curr_status) }}">
                                        ä¸Šä¸€é¡µ
                                    </a>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        ç¬¬ {{ pagination.page }} / {{ pagination.pages }} é¡µ
                                    </span>
                                </li>
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link"
                                        href="{{ url_for('admin_dashboard', page=pagination.next_num, keyword=curr_keyword, status=curr_status) }}">
                                        ä¸‹ä¸€é¡µ
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-notice">
                        <div class="card mb-4">
                            <div class="card-header">å‘å¸ƒæ–°å…¬å‘Š</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="publish_notice" value="1">
                                    <div class="mb-2">
                                        <input type="text" name="title" class="form-control" placeholder="å…¬å‘Šæ ‡é¢˜"
                                            required>
                                    </div>
                                    <div class="mb-2">
                                        <textarea name="content" class="form-control" placeholder="å…¬å‘Šå†…å®¹" rows="3"
                                            required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">å‘å¸ƒ</button>
                                </form>
                            </div>
                        </div>
                        <h5>å†å²å…¬å‘Š</h5>
                        <ul class="list-group">
                            {% for notice in announcements %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ notice.title }}
                                <span class="badge bg-secondary">
                                    {{ notice.created_at.strftime('%Y-%m-%d') }}
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="tab-pane fade" id="tab-config">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                ç³»ç»Ÿæ€»å¼€å…³
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="toggle_system" value="1">
                                    {% if config.is_open %}
                                    <button class="btn btn-danger btn-sm">å…³é—­é¢„çº¦ç³»ç»Ÿ</button>
                                    {% else %}
                                    <button class="btn btn-success btn-sm">å¼€å¯é¢„çº¦ç³»ç»Ÿ</button>
                                    {% endif %}
                                </form>
                            </div>
                            <div class="card-body">
                                å½“å‰çŠ¶æ€ï¼š
                                {% if config.is_open %}
                                <span class="text-success fw-bold">å¼€æ”¾ä¸­</span>
                                {% else %}
                                <span class="text-danger fw-bold">å·²å…³é—­ç»´æŠ¤</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">åŸºç¡€å‚æ•°è®¾ç½®</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="update_config" value="1">
                                    <div class="mb-3">
                                        <label>å¯å‚è§‚æ ¡åŒº (ç”¨é€—å·åˆ†éš”)</label>
                                        <input type="text" name="campuses" class="form-control"
                                            value="{{ config.campuses }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>å‚è§‚æ—¶é—´æ®µ (ç”¨é€—å·åˆ†éš”)</label>
                                        <input type="text" name="visit_times" class="form-control"
                                            value="{{ config.visit_times }}">
                                    </div>
                                    <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">éšç§å£°æ˜é…ç½®</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="update_policy" value="1">
                                    <div class="mb-3">
                                        <label class="form-label text-muted small">
                                            æ”¯æŒ HTML æ ¼å¼ï¼ˆä¾‹å¦‚ &lt;br&gt; æ¢è¡Œï¼‰
                                        </label>
                                        <textarea name="privacy_policy" class="form-control"
                                            rows="8">{{ config.privacy_policy }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        æ›´æ–°éšç§å£°æ˜
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-account">

                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">ä¿®æ”¹æˆ‘çš„å¯†ç </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_account') }}"
                                    class="row g-2 align-items-center">
                                    <input type="hidden" name="action" value="change_own_password">
                                    <div class="col-auto">
                                        <input type="password" name="new_password" class="form-control"
                                            placeholder="è¾“å…¥æ–°å¯†ç " required>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-dark">ç¡®è®¤ä¿®æ”¹</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        {% if session['is_super'] %}
                        <div class="card">
                            <div
                                class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                ç®¡ç†å‘˜åˆ—è¡¨
                                <button class="btn btn-light btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#addAdminModal">
                                    + æ–°å¢ç®¡ç†å‘˜
                                </button>
                            </div>
                            <div class="card-body">
                                <table class="table table-striped align-middle">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>ç”¨æˆ·å</th>
                                            <th>è§’è‰²</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for admin in admin_list %}
                                        <tr>
                                            <td>{{ admin.id }}</td>
                                            <td>{{ admin.username }}</td>
                                            <td>
                                                {% if admin.is_super %}
                                                <span class="badge bg-danger">è¶…çº§ç®¡ç†å‘˜</span>
                                                {% else %}
                                                <span class="badge bg-info text-dark">æ™®é€šç®¡ç†å‘˜</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if not admin.is_super %}
                                                <div class="d-flex gap-2">
                                                    <form method="POST" action="{{ url_for('admin_account') }}"
                                                        style="display:inline-flex; gap:5px;">
                                                        <input type="hidden" name="action" value="reset_password">
                                                        <input type="hidden" name="admin_id" value="{{ admin.id }}">
                                                        <input type="text" name="new_password"
                                                            class="form-control form-control-sm" placeholder="æ–°å¯†ç "
                                                            style="width:100px;" required>
                                                        <button class="btn btn-sm btn-outline-warning">
                                                            é‡ç½®
                                                        </button>
                                                    </form>

                                                    <form method="POST" action="{{ url_for('admin_account') }}"
                                                        onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥ç®¡ç†å‘˜ï¼Ÿ');">
                                                        <input type="hidden" name="action" value="delete_admin">
                                                        <input type="hidden" name="admin_id" value="{{ admin.id }}">
                                                        <button class="btn btn-sm btn-outline-danger">
                                                            åˆ é™¤
                                                        </button>
                                                    </form>
                                                </div>
                                                {% else %}
                                                <small class="text-muted">ä¸å¯æ“ä½œ</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="auditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é¢„çº¦è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="detail-label">æäº¤æ—¶é—´</div>
                            <div class="detail-value" id="m-time"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">å§“å</div>
                            <div class="detail-value fw-bold" id="m-name"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">è¯ä»¶ç±»å‹</div>
                            <div class="detail-value" id="m-idtype"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">è¯ä»¶å·ç </div>
                            <div class="detail-value font-monospace" id="m-idcard"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">æ‰‹æœºå·</div>
                            <div class="detail-value" id="m-phone"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">èº«ä»½</div>
                            <div class="detail-value" id="m-identity"></div>
                        </div>
                        <div class="col-12">
                            <hr class="my-2">
                        </div>
                        <div class="col-6">
                            <div class="detail-label">å‚è§‚æ—¶é—´</div>
                            <div class="detail-value text-primary" id="m-visitdate"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">æ ¡åŒº</div>
                            <div class="detail-value" id="m-area"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="detail-label">ç”³è¯·ç†ç”±</div>
                        <div class="reason-box" id="m-reason"></div>
                    </div>

                    <div id="m-old-reject" class="alert alert-danger py-2" style="display:none;">
                        <strong>æ‹’ç»åŸå› ï¼š</strong>
                        <span id="m-old-reject-text"></span>
                    </div>

                    <form method="POST" id="auditForm">
                        <input type="hidden" name="action" id="actionInput">
                        <div class="collapse mb-3" id="rejectInputArea">
                            <label class="form-label text-danger fw-bold">
                                è¯·å¡«å†™æ‹’ç»ç†ç”±ï¼š
                            </label>
                            <textarea name="reject_reason" id="rejectReasonText" class="form-control border-danger"
                                rows="2" placeholder="ä¾‹å¦‚ï¼šè¯¥æ—¶é—´æ®µé¢„çº¦å·²æ»¡"></textarea>
                        </div>
                    </form>
                </div>

                <div class="modal-footer bg-light">
                    <div id="btn-group-pending"
                        style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>

                        <button type="button" class="btn btn-danger" id="btn-reject-trigger"
                            onclick="showRejectInput()">æ‹’ç»</button>

                        <button type="button" class="btn btn-danger" id="btn-reject-confirm"
                            onclick="submitAudit('reject')" style="display:none;">
                            ç¡®è®¤æ‹’ç»
                        </button>

                        <button type="button" class="btn btn-success" id="btn-approve"
                            onclick="submitAudit('approve')">åŒæ„</button>
                    </div>

                    <div id="btn-group-done" style="display: none;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addAdminModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å¢æ™®é€šç®¡ç†å‘˜</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('admin_account') }}">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="create_admin">
                        <div class="mb-3">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" name="username" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>åˆå§‹å¯†ç </label>
                            <input type="text" name="password" class="form-control" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        var auditModal = new bootstrap.Modal(document.getElementById('auditModal'));

        // 1. æ‰“å¼€å®¡æ ¸å¼¹çª—
        function openAuditModal(btn) {
            const data = btn.dataset;
            document.getElementById('m-time').innerText = data.time;
            document.getElementById('m-name').innerText = data.name;
            document.getElementById('m-phone').innerText = data.phone;
            document.getElementById('m-idtype').innerText = data.idtype || 'èº«ä»½è¯';
            document.getElementById('m-idcard').innerText = data.idcard;
            document.getElementById('m-identity').innerText = data.identity;
            document.getElementById('m-visitdate').innerText = data.visitdate;
            document.getElementById('m-area').innerText = data.area;
            document.getElementById('m-reason').innerText = data.reason;

            const form = document.getElementById('auditForm');
            form.action = "/admin/audit/" + data.id;

            // UI çŠ¶æ€é‡ç½®
            const pendingGroup = document.getElementById('btn-group-pending');
            const doneGroup = document.getElementById('btn-group-done');
            const rejectArea = document.getElementById('rejectInputArea');
            const oldRejectArea = document.getElementById('m-old-reject');
            const btnApprove = document.getElementById('btn-approve');
            const btnRejectConfirm = document.getElementById('btn-reject-confirm');

            rejectArea.classList.remove('show');
            document.getElementById('btn-reject-trigger').style.display = 'inline-block';
            btnRejectConfirm.style.display = 'none';
            btnRejectConfirm.disabled = false;
            btnRejectConfirm.innerHTML = 'ç¡®è®¤æ‹’ç»';
            btnApprove.disabled = false;
            btnApprove.innerHTML = 'åŒæ„';
            document.getElementById('rejectReasonText').value = '';

            if (data.status === 'å¾…å®¡æ ¸') {
                pendingGroup.style.display = 'flex';
                doneGroup.style.display = 'none';
                oldRejectArea.style.display = 'none';
            } else {
                pendingGroup.style.display = 'none';
                doneGroup.style.display = 'block';
                if (data.status === 'å·²æ‹’ç»') {
                    oldRejectArea.style.display = 'block';
                    document.getElementById('m-old-reject-text').innerText = data.rejectreason;
                } else {
                    oldRejectArea.style.display = 'none';
                }
            }
            auditModal.show();
        }

        // 2. å±•å¼€æ‹’ç»è¾“å…¥æ¡†
        function showRejectInput() {
            document.getElementById('rejectInputArea').classList.add('show');
            document.getElementById('btn-approve').disabled = true;
            document.getElementById('btn-reject-trigger').style.display = 'none';
            document.getElementById('btn-reject-confirm').style.display = 'inline-block';
        }

        // 3. æäº¤å®¡æ ¸ (é˜²é‡å¤æäº¤)
        function submitAudit(actionType) {
            const actionInput = document.getElementById('actionInput');
            actionInput.value = actionType;
            const form = document.getElementById('auditForm');

            if (actionType === 'reject') {
                const reason = document.getElementById('rejectReasonText').value.trim();
                if (!reason) { alert("è¯·å¡«å†™æ‹’ç»ç†ç”±ï¼"); return; }
            }

            const btnApprove = document.getElementById('btn-approve');
            const btnRejectConfirm = document.getElementById('btn-reject-confirm');

            // Loading çŠ¶æ€
            if (actionType === 'approve') {
                btnApprove.disabled = true;
                btnApprove.innerHTML =
                    '<span class="spinner-border spinner-border-sm"></span> å¤„ç†ä¸­...';
            } else {
                btnRejectConfirm.disabled = true;
                btnRejectConfirm.innerHTML =
                    '<span class="spinner-border spinner-border-sm"></span> å¤„ç†ä¸­...';
            }
            form.submit();
        }
    </script>
</body>

</html>