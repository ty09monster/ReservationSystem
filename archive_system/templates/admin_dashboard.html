<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå°</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-dark bg-dark px-4">
        <a class="navbar-brand" href="#">æ¡£æ¡ˆé¦†é¢„çº¦ç®¡ç†ç³»ç»Ÿ</a>
        <span class="navbar-text text-white">ç®¡ç†å‘˜</span>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-2">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-audit">ğŸ“… é¢„çº¦å®¡æ ¸</button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-notice">ğŸ“¢ å…¬å‘Šç®¡ç†</button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-config">âš™ï¸ ç³»ç»Ÿé…ç½®</button>
                </div>
            </div>

            <div class="col-md-10">
                <div class="tab-content">

                    <div class="tab-pane fade show active" id="tab-audit">
                        <h4>é¢„çº¦ç”³è¯·åˆ—è¡¨</h4>
                        <table class="table table-striped table-hover mt-3">
                            <thead>
                                <tr>
                                    <th>æäº¤æ—¶é—´</th>
                                    <th>å§“å</th>
                                    <th>è¯ä»¶ä¿¡æ¯</th>
                                    <th>æ‰‹æœº</th>
                                    <th>èº«ä»½</th>
                                    <th>æ—¥æœŸ/æ ¡åŒº</th>
                                    <th>ç¼˜ç”±</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for res in reservations %}
                                <tr>
                                    <td>{{ res.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ res.user.name }}</td>
                                    <td>{{ res.user.phone }}</td>
                                    <td><span class="badge bg-secondary">{{ res.user.identity }}</span></td>
                                    <td>{{ res.visit_date }}<br><small>{{ res.area }}</small></td>
                                    <td style="max-width: 200px;">{{ res.reason }}</td>
                                    <td>
                                        {% if res.status == 'å¾…å®¡æ ¸' %}
                                        <span class="badge bg-warning text-dark">å¾…å®¡æ ¸</span>
                                        {% elif res.status == 'å·²åŒæ„' %}
                                        <span class="badge bg-success">å·²åŒæ„</span>
                                        {% else %}
                                        <span class="badge bg-danger">å·²æ‹’ç»</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if res.status == 'å¾…å®¡æ ¸' %}
                                        <form method="POST" action="{{ url_for('admin_audit', res_id=res.id) }}"
                                            class="d-flex gap-1">
                                            <button name="action" value="approve"
                                                class="btn btn-sm btn-success">åŒæ„</button>
                                            <button type="button" class="btn btn-sm btn-danger"
                                                onclick="promptReject('{{ res.id }}')">æ‹’ç»</button>

                                            <input type="hidden" name="action" value="reject" id="action-{{ res.id }}"
                                                disabled>
                                            <input type="hidden" name="reject_reason" id="reason-{{ res.id }}">
                                        </form>
                                        {% else %}
                                        <small class="text-muted">å·²å¤„ç†</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-pane fade" id="tab-notice">
                        <div class="card mb-4">
                            <div class="card-header">å‘å¸ƒæ–°å…¬å‘Š</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="publish_notice" value="1">
                                    <div class="mb-2">
                                        <input type="text" name="title" class="form-control" placeholder="å…¬å‘Šæ ‡é¢˜"
                                            required>
                                    </div>
                                    <div class="mb-2">
                                        <textarea name="content" class="form-control" placeholder="å…¬å‘Šå†…å®¹" rows="3"
                                            required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">å‘å¸ƒ</button>
                                </form>
                            </div>
                        </div>
                        <h5>å†å²å…¬å‘Š</h5>
                        <ul class="list-group">
                            {% for notice in announcements %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ notice.title }}
                                <span class="badge bg-secondary">{{ notice.created_at.strftime('%Y-%m-%d') }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="tab-pane fade" id="tab-config">

                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                ç³»ç»Ÿæ€»å¼€å…³
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="toggle_system" value="1">
                                    {% if config.is_open %}
                                    <button class="btn btn-danger btn-sm">å…³é—­é¢„çº¦ç³»ç»Ÿ</button>
                                    {% else %}
                                    <button class="btn btn-success btn-sm">å¼€å¯é¢„çº¦ç³»ç»Ÿ</button>
                                    {% endif %}
                                </form>
                            </div>
                            <div class="card-body">
                                å½“å‰çŠ¶æ€ï¼š
                                {% if config.is_open %}
                                <span class="text-success fw-bold">å¼€æ”¾ä¸­</span>
                                {% else %}
                                <span class="text-danger fw-bold">å·²å…³é—­ç»´æŠ¤</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">åŸºç¡€å‚æ•°è®¾ç½®</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="update_config" value="1">
                                    <div class="mb-3">
                                        <label>å¯å‚è§‚æ ¡åŒº (ç”¨é€—å·åˆ†éš”)</label>
                                        <input type="text" name="campuses" class="form-control"
                                            value="{{ config.campuses }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>å‚è§‚æ—¶é—´æ®µ (ç”¨é€—å·åˆ†éš”)</label>
                                        <input type="text" name="visit_times" class="form-control"
                                            value="{{ config.visit_times }}">
                                    </div>
                                    <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">éšç§å£°æ˜é…ç½®</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="update_policy" value="1">

                                    <div class="mb-3">
                                        <label class="form-label text-muted small">æ”¯æŒ HTML æ ¼å¼ï¼ˆä¾‹å¦‚ &lt;br&gt; æ¢è¡Œï¼Œ&lt;b&gt;
                                            åŠ ç²—ï¼‰</label>
                                        <textarea name="privacy_policy" class="form-control"
                                            rows="8">{{ config.privacy_policy }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">æ›´æ–°éšç§å£°æ˜</button>
                                </form>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        function promptReject(id) {
            const reason = prompt("è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼š");
            if (reason) {
                document.getElementById('reason-' + id).value = reason;
                const actionInput = document.getElementById('action-' + id);
                actionInput.disabled = false; // å¯ç”¨inputä»¥ä¾¿æäº¤
                actionInput.form.submit();
            }
        }
    </script>
</body>

</html>