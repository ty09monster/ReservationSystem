<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå°</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
        /* [æ–°å¢] ç”³è¯·ç†ç”±çš„æ»šåŠ¨åŒºåŸŸæ ·å¼ */
        .reason-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 100px;
            /* å›ºå®šé«˜åº¦ */
            overflow-y: auto;
            /* å†…å®¹å¤šäº†æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 15px;
        }

        /* å¼¹çª—å†…çš„æ ‡ç­¾æ ·å¼ */
        .detail-label {
            font-weight: bold;
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .detail-value {
            margin-bottom: 12px;
            font-size: 1rem;
            word-break: break-all;
            /* é˜²æ­¢é•¿å­—ç¬¦ä¸²æ’‘ç ´å¸ƒå±€ */
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark px-4">
        <a class="navbar-brand" href="#">æ¡£æ¡ˆé¦†é¢„çº¦ç®¡ç†ç³»ç»Ÿ</a>
        <span class="navbar-text text-white">ç®¡ç†å‘˜</span>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-2">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-audit">ğŸ“… é¢„çº¦å®¡æ ¸</button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-notice">ğŸ“¢ å…¬å‘Šç®¡ç†</button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-config">âš™ï¸ ç³»ç»Ÿé…ç½®</button>
                </div>
            </div>

            <div class="col-md-10">
                <div class="tab-content">

                    <div class="tab-pane fade show active" id="tab-audit">
                        <h4>é¢„çº¦ç”³è¯·åˆ—è¡¨</h4>
                        <table class="table table-hover mt-3 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>æäº¤æ—¶é—´</th>
                                    <th>å§“å</th>
                                    <th>èº«ä»½</th>
                                    <th>å‚è§‚æ—¥æœŸ/æ—¶é—´</th>
                                    <th>æ ¡åŒº</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for res in reservations %}
                                <tr>
                                    <td>{{ res.created_at.strftime('%m-%d %H:%M') }}</td>
                                    <td>{{ res.user.name }}</td>
                                    <td><span class="badge bg-secondary">{{ res.identity }}</span></td>
                                    <td>
                                        {{ res.visit_date }}
                                        <br>
                                        <small class="text-muted">{{ res.visit_time }}</small>
                                    </td>
                                    <td>{{ res.area }}</td>
                                    <td>
                                        {% if res.status == 'å¾…å®¡æ ¸' %}
                                        <span class="badge bg-warning text-dark">å¾…å®¡æ ¸</span>
                                        {% elif res.status == 'å·²åŒæ„' %}
                                        <span class="badge bg-success">å·²åŒæ„</span>
                                        {% else %}
                                        <span class="badge bg-danger">å·²æ‹’ç»</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="openAuditModal(this)"
                                            data-id="{{ res.id }}"
                                            data-time="{{ res.created_at.strftime('%Y-%m-%d %H:%M') }}"
                                            data-name="{{ res.user.name }}" data-phone="{{ res.user.phone }}"
                                            data-idtype="{{ res.user.id_type }}" data-idcard="{{ res.user.id_card }}"
                                            data-identity="{{ res.identity }}"
                                            data-visitdate="{{ res.visit_date }} {{ res.visit_time }}"
                                            data-area="{{ res.area }}" data-reason="{{ res.reason }}"
                                            data-status="{{ res.status }}"
                                            data-rejectreason="{{ res.reject_reason or '' }}">
                                            æŸ¥çœ‹è¯¦æƒ…
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-pane fade" id="tab-notice">
                        <div class="card mb-4">
                            <div class="card-header">å‘å¸ƒæ–°å…¬å‘Š</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="publish_notice" value="1">
                                    <div class="mb-2">
                                        <input type="text" name="title" class="form-control" placeholder="å…¬å‘Šæ ‡é¢˜"
                                            required>
                                    </div>
                                    <div class="mb-2">
                                        <textarea name="content" class="form-control" placeholder="å…¬å‘Šå†…å®¹" rows="3"
                                            required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">å‘å¸ƒ</button>
                                </form>
                            </div>
                        </div>
                        <h5>å†å²å…¬å‘Š</h5>
                        <ul class="list-group">
                            {% for notice in announcements %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ notice.title }}
                                <span class="badge bg-secondary">{{ notice.created_at.strftime('%Y-%m-%d') }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="tab-pane fade" id="tab-config">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                ç³»ç»Ÿæ€»å¼€å…³
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="toggle_system" value="1">
                                    {% if config.is_open %}
                                    <button class="btn btn-danger btn-sm">å…³é—­é¢„çº¦ç³»ç»Ÿ</button>
                                    {% else %}
                                    <button class="btn btn-success btn-sm">å¼€å¯é¢„çº¦ç³»ç»Ÿ</button>
                                    {% endif %}
                                </form>
                            </div>
                            <div class="card-body">
                                å½“å‰çŠ¶æ€ï¼š
                                {% if config.is_open %}
                                <span class="text-success fw-bold">å¼€æ”¾ä¸­</span>
                                {% else %}
                                <span class="text-danger fw-bold">å·²å…³é—­ç»´æŠ¤</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">åŸºç¡€å‚æ•°è®¾ç½®</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="update_config" value="1">
                                    <div class="mb-3">
                                        <label>å¯å‚è§‚æ ¡åŒº (ç”¨é€—å·åˆ†éš”)</label>
                                        <input type="text" name="campuses" class="form-control"
                                            value="{{ config.campuses }}">
                                    </div>
                                    <div class="mb-3">
                                        <label>å‚è§‚æ—¶é—´æ®µ (ç”¨é€—å·åˆ†éš”)</label>
                                        <input type="text" name="visit_times" class="form-control"
                                            value="{{ config.visit_times }}">
                                    </div>
                                    <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">éšç§å£°æ˜é…ç½®</div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin_config') }}">
                                    <input type="hidden" name="update_policy" value="1">
                                    <div class="mb-3">
                                        <label class="form-label text-muted small">æ”¯æŒ HTML æ ¼å¼ï¼ˆä¾‹å¦‚ &lt;br&gt; æ¢è¡Œï¼Œ&lt;b&gt;
                                            åŠ ç²—ï¼‰</label>
                                        <textarea name="privacy_policy" class="form-control"
                                            rows="8">{{ config.privacy_policy }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">æ›´æ–°éšç§å£°æ˜</button>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="auditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é¢„çº¦è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="detail-label">æäº¤æ—¶é—´</div>
                            <div class="detail-value" id="m-time"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">å§“å</div>
                            <div class="detail-value fw-bold" id="m-name"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">è¯ä»¶ç±»å‹</div>
                            <div class="detail-value" id="m-idtype"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">è¯ä»¶å·ç </div>
                            <div class="detail-value font-monospace" id="m-idcard"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">æ‰‹æœºå·</div>
                            <div class="detail-value" id="m-phone"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">èº«ä»½</div>
                            <div class="detail-value" id="m-identity"></div>
                        </div>

                        <div class="col-12">
                            <hr class="my-2">
                        </div>

                        <div class="col-6">
                            <div class="detail-label">å‚è§‚æ—¶é—´</div>
                            <div class="detail-value text-primary" id="m-visitdate"></div>
                        </div>
                        <div class="col-6">
                            <div class="detail-label">æ ¡åŒº</div>
                            <div class="detail-value" id="m-area"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="detail-label">ç”³è¯·ç†ç”±</div>
                        <div class="reason-box" id="m-reason"></div>
                    </div>

                    <div id="m-old-reject" class="alert alert-danger py-2" style="display:none;">
                        <strong>æ‹’ç»åŸå› ï¼š</strong> <span id="m-old-reject-text"></span>
                    </div>

                    <form method="POST" id="auditForm">
                        <input type="hidden" name="action" id="actionInput">

                        <div class="collapse mb-3" id="rejectInputArea">
                            <label class="form-label text-danger fw-bold">è¯·å¡«å†™æ‹’ç»ç†ç”±ï¼š</label>
                            <textarea name="reject_reason" id="rejectReasonText" class="form-control border-danger"
                                rows="2" placeholder="ä¾‹å¦‚ï¼šè¯¥æ—¶é—´æ®µé¢„çº¦å·²æ»¡"></textarea>
                        </div>
                    </form>
                </div>

                <div class="modal-footer bg-light">
                    <div id="btn-group-pending"
                        style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>

                        <button type="button" class="btn btn-danger" id="btn-reject-trigger"
                            onclick="showRejectInput()">æ‹’ç»</button>
                        <button type="button" class="btn btn-danger" id="btn-reject-confirm"
                            onclick="submitAudit('reject')" style="display:none;">ç¡®è®¤æ‹’ç»</button>

                        <button type="button" class="btn btn-success" id="btn-approve"
                            onclick="submitAudit('approve')">åŒæ„</button>
                    </div>

                    <div id="btn-group-done" style="display: none;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // åˆå§‹åŒ– Modal
        var auditModal = new bootstrap.Modal(document.getElementById('auditModal'));

        // 1. æ‰“å¼€å¼¹çª—å¹¶å¡«å……æ•°æ®
        function openAuditModal(btn) {
            const data = btn.dataset;

            // å¡«å……æ•°æ®
            document.getElementById('m-time').innerText = data.time;
            document.getElementById('m-name').innerText = data.name;
            document.getElementById('m-phone').innerText = data.phone;
            document.getElementById('m-idtype').innerText = data.idtype || 'èº«ä»½è¯';
            document.getElementById('m-idcard').innerText = data.idcard;
            document.getElementById('m-identity').innerText = data.identity;
            document.getElementById('m-visitdate').innerText = data.visitdate;
            document.getElementById('m-area').innerText = data.area;
            document.getElementById('m-reason').innerText = data.reason;

            // è®¾ç½®è¡¨å•æäº¤åœ°å€
            const form = document.getElementById('auditForm');
            form.action = "/admin/audit/" + data.id;

            // UI çŠ¶æ€é‡ç½®
            const pendingGroup = document.getElementById('btn-group-pending');
            const doneGroup = document.getElementById('btn-group-done');
            const rejectArea = document.getElementById('rejectInputArea');
            const oldRejectArea = document.getElementById('m-old-reject');

            rejectArea.classList.remove('show'); // æ”¶èµ·æ‹’ç»è¾“å…¥æ¡†
            document.getElementById('btn-reject-trigger').style.display = 'inline-block';
            document.getElementById('btn-reject-confirm').style.display = 'none';
            document.getElementById('btn-approve').disabled = false;
            document.getElementById('rejectReasonText').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

            if (data.status === 'å¾…å®¡æ ¸') {
                pendingGroup.style.display = 'flex';
                doneGroup.style.display = 'none';
                oldRejectArea.style.display = 'none';
            } else {
                pendingGroup.style.display = 'none';
                doneGroup.style.display = 'block';

                // å¦‚æœæ˜¯å·²æ‹’ç»ï¼Œæ˜¾ç¤ºå†å²åŸå› 
                if (data.status === 'å·²æ‹’ç»') {
                    oldRejectArea.style.display = 'block';
                    document.getElementById('m-old-reject-text').innerText = data.rejectreason;
                } else {
                    oldRejectArea.style.display = 'none';
                }
            }

            auditModal.show();
        }

        // 2. ç‚¹å‡»â€œæ‹’ç»â€æŒ‰é’®ï¼Œå±•å¼€è¾“å…¥æ¡†
        function showRejectInput() {
            document.getElementById('rejectInputArea').classList.add('show');
            document.getElementById('btn-approve').disabled = true; // æ—¢ç„¶è¦æ‹’ç»ï¼Œå°±ç¦ç”¨åŒæ„

            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
            document.getElementById('btn-reject-trigger').style.display = 'none';
            document.getElementById('btn-reject-confirm').style.display = 'inline-block';
        }

        // 3. æäº¤å®¡æ ¸
        function submitAudit(actionType) {
            const actionInput = document.getElementById('actionInput');
            actionInput.value = actionType;

            // æ‹’ç»æ—¶çš„éç©ºæ ¡éªŒ
            if (actionType === 'reject') {
                const reason = document.getElementById('rejectReasonText').value.trim();
                if (!reason) {
                    alert("è¯·å¡«å†™æ‹’ç»ç†ç”±ï¼");
                    return;
                }
            }

            document.getElementById('auditForm').submit();
        }
    </script>
</body>

</html>