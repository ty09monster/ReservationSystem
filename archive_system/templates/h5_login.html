<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>档案馆预约 - 登录</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
        /* --- 原有样式 --- */
        .is-invalid {
            border-color: #dc3545;
            background-image: none;
        }

        .invalid-feedback {
            display: none;
            color: #dc3545;
            font-size: 0.875em;
        }

        /* --- [新增] 协议行样式 --- */
        .policy-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        .policy-row input[type="checkbox"] {
            margin-top: 4px;
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        .policy-link {
            color: #0d6efd; /* Bootstrap 蓝色 */
            text-decoration: underline;
            cursor: pointer;
            font-weight: 500;
        }

        /* --- [新增] 弹窗遮罩层 (适配微信) --- */
        .modal-mask {
            display: none; /* 默认隐藏 */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1050; /* 比 Bootstrap navbar 高 */
            justify-content: center;
            align-items: center;
        }

        /* --- [新增] 弹窗主体 --- */
        .modal-box {
            background: #fff;
            width: 85%;
            max-height: 80%;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .modal-header-custom {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .modal-body-custom {
            padding: 15px;
            overflow-y: auto; /* 内容过长可滚动 */
            flex: 1;
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .modal-footer-custom {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <h4 class="text-center mb-4">访客身份认证</h4>

                {% with messages = get_flashed_messages() %}
                {% if messages %}
                <div class="alert alert-danger">{{ messages[0] }}</div>
                {% endif %}
                {% endwith %}

                <form method="POST" id="loginForm" onsubmit="return validateForm()">
                    <!-- 隐藏字段，用于存储登录后跳转的URL -->
                    <input type="hidden" name="next" value="{{ request.args.get('next', '') }}">
                    <div class="mb-3">
                        <label class="form-label">姓名</label>
                        <input type="text" name="name" class="form-control" required value="{{ prev_name or '' }}"
                            placeholder="请输入真实姓名">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">证件类型</label>
                        <select name="id_type" id="idType" class="form-select" required onchange="checkIdCard()">
                            <option value="身份证" {% if prev_id_type=='身份证' %}selected{% endif %}>身份证</option>
                            <option value="港澳居民来往内地通行证" {% if prev_id_type=='港澳居民来往内地通行证' %}selected{% endif %}>
                                港澳居民来往内地通行证</option>
                            <option value="台湾居民来往大陆通行证" {% if prev_id_type=='台湾居民来往大陆通行证' %}selected{% endif %}>
                                台湾居民来往大陆通行证</option>
                            <option value="港澳台居民居住证" {% if prev_id_type=='港澳台居民居住证' %}selected{% endif %}>港澳台居民居住证
                            </option>
                            <option value="外国人永久居留身份证" {% if prev_id_type=='外国人永久居留身份证' %}selected{% endif %}>外国人永久居留身份证
                            </option>
                            <option value="护照" {% if prev_id_type=='护照' %}selected{% endif %}>护照（仅限外籍人士）</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">证件号码</label>
                        <input type="text" name="id_card" id="idCard" class="form-control" required
                            value="{{ prev_id_card or '' }}" placeholder="请输入证件号码" onblur="checkIdCard()">
                        <div class="invalid-feedback" id="idError">证件号码格式有误</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">手机号</label>
                        <input type="tel" name="phone" id="phone" class="form-control" required
                            value="{{ prev_phone or '' }}" placeholder="用于接收通知" maxlength="11" onblur="checkPhone()">
                        <div class="invalid-feedback" id="phoneError">手机号格式错误</div>
                    </div>

                    <div class="policy-row">
                        <input type="checkbox" id="agreeCheck" onchange="toggleSubmit()">
                        <label for="agreeCheck">
                            我已阅读并同意 <span class="policy-link" onclick="openPrivacyModal()">《预约系统隐私声明与免责条款》</span>
                        </label>
                    </div>

                    <button type="submit" id="submitBtn" class="btn btn-primary w-100" disabled>进入系统</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-mask" id="privacyModal">
        <div class="modal-box">
            <div class="modal-header-custom">隐私声明与免责条款</div>
            <div class="modal-body-custom">
                {{ privacy_policy | safe }}
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn btn-success px-4" onclick="closePrivacyModal()">我已阅读</button>
            </div>
        </div>
    </div>

    <script>
        // --- [新增] 1. 按钮启用/禁用逻辑 ---
        function toggleSubmit() {
            const checkbox = document.getElementById('agreeCheck');
            const btn = document.getElementById('submitBtn');
            // 如果勾选，按钮解除禁用；否则禁用
            btn.disabled = !checkbox.checked;
        }

        // --- [新增] 2. 弹窗显示逻辑 ---
        function openPrivacyModal() {
            document.getElementById('privacyModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // 禁止背景滚动
        }

        // --- [新增] 3. 弹窗关闭逻辑 ---
        function closePrivacyModal() {
            document.getElementById('privacyModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // 恢复背景滚动
        }

        // 点击遮罩层也可以关闭
        document.getElementById('privacyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePrivacyModal();
            }
        });

        // ==========================================
        // 以下是你原有的前端校验逻辑 (保持不变)
        // ==========================================

        function checkIdCard() {
            const type = document.getElementById('idType').value;
            const input = document.getElementById('idCard');
            const errorDiv = document.getElementById('idError');
            let val = input.value.trim().toUpperCase();
            input.value = val; // 自动转大写

            let isValid = true;
            let msg = "";

            if (!val) return; // 空值不校验

            if (type === '身份证' || type === '港澳台居民居住证') {
                const res = validateCnId(val);
                isValid = res.valid;
                msg = res.msg;
            } else if (type === '港澳居民来往内地通行证') {
                isValid = /^[HM]\d{8,10}$/.test(val);
                msg = "格式应为 H/M + 8或10位数字";
            } else if (type === '台湾居民来往大陆通行证') {
                isValid = /^\d{8}$/.test(val);
                msg = "格式应为 8位数字";
            } else if (type === '外国人永久居留身份证') {
                if (val.length === 18 && val.startsWith('9')) {
                    const res = validateCnId(val);
                    isValid = res.valid;
                    msg = res.msg;
                } else {
                    isValid = /^[A-Z]{3}\d{12}$/.test(val);
                    msg = "格式应为 15位旧版或18位新版";
                }
            }

            // UI 反馈
            if (isValid) {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                errorDiv.style.display = 'none';
                return true;
            } else {
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                errorDiv.innerText = msg;
                errorDiv.style.display = 'block';
                return false;
            }
        }

        // 身份证/居住证 核心算法 (ISO 7064:1983.MOD 11-2)
        function validateCnId(code) {
            if (code.length !== 18) return { valid: false, msg: "长度必须为18位" };
            if (!/^\d{17}[\dX]$/.test(code)) return { valid: false, msg: "包含非法字符" };

            const factor = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
            const parity = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];

            let sum = 0;
            for (let i = 0; i < 17; i++) {
                sum += parseInt(code[i]) * factor[i];
            }

            const expectedLast = parity[sum % 11];
            if (code[17] !== expectedLast) {
                return { valid: false, msg: "校验位错误，请核对号码" };
            }
            return { valid: true, msg: "" };
        }

        // 修改：表单提交拦截，必须两个都通过
        function validateForm() {
            const isIdValid = checkIdCard(); // 校验身份证
            const isPhoneValid = checkPhone(); // 校验手机号
            
            // 只有两个都为 true 时才提交
            return isIdValid && isPhoneValid;
        }

        // 新增：手机号校验函数
        function checkPhone() {
            const input = document.getElementById('phone');
            const errorDiv = document.getElementById('phoneError');
            const val = input.value.trim();

            // 正则：1开头，第二位3-9，后面9位数字
            const isValid = /^1[3-9]\d{9}$/.test(val);

            if (isValid) {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                errorDiv.style.display = 'none';
                return true;
            } else {
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                errorDiv.innerText = "请输入有效的11位手机号";
                errorDiv.style.display = 'block';
                return false;
            }
        }

    </script>
</body>

</html>